# Создание REST API для Telegram бота с использованием Node.js, MongoDB и Nginx

## 1. Установка необходимых библиотек

Сначала создаем новую папку для нашего проекта и переходим в неё:

```bash
mkdir telegram-bot
cd telegram-bot
```

Инициализируем новый проект Node.js:

```bash
npm init -y
```

Установите необходимые библиотеки:

```bash
npm install express node-telegram-bot-api mongoose node-cron body-parser
```

- **express**: фреймворк для Node.js.
- **node-telegram-bot-api**: библиотека для работы с Telegram API.
- **mongoose**: библиотека для работы с MongoDB.
- **node-cron**: библиотека для передического запуска кода.
- **body-parser**: библиотека для обработки JSON-данных.

## 2. Создание файлов и папок

Создаем следующие файлы в корне вашего проекта:

- `db.js`
- `User.js`
- `botApp.js`
- `notificationApp.js`

## 3. Настройка подключения к MongoDB

### Файл: `db.js`

```javascript
const mongoose = require('mongoose'); // Подключаем библиотеку mongoose

// Функция для подключения к MongoDB
const connectDB = async () => {
  try {
    await mongoose.connect('mongodb://mongo-user-mygeobot:password@195.80.51.100:27017/mygeobot', { // Подключаемся к MongoDB по указанному URL
      useNewUrlParser: true, // Используем новый парсер URL
      useUnifiedTopology: true, // Используем новую топологию подключения
    });
    console.log('MongoDB подключен'); // Выводим сообщение об успешном подключении
  } catch (error) {
    console.error('Ошибка подключения к MongoDB:', error.message); // Обрабатываем ошибки подключения
    process.exit(1); // Завершаем процесс при ошибке
  }
};

module.exports = connectDB; // Экспортируем функцию подключения
```

## 4. Создание модели пользователя

### Файл: `User.js`

```javascript
// User.js
const mongoose = require('mongoose'); // Подключаем библиотеку mongoose

// Определяем схему пользователя
const userSchema = new mongoose.Schema({
    chatId: {
        type: String,
        required: true,
        unique: true, // Уникальное значение для каждого пользователя
    },
    firstName: {
        type: String,
        required: true, // Обязательное поле
    },
    lastName: {
        type: String,
        required: false, // Необязательное поле
    },
    username: {
        type: String,
        required: false, // Необязательное поле
    },
    createdAt: {
        type: Date,
        default: Date.now, // Дата создания по умолчанию
    },
    sleepTime: {
        type: String, // Время сна в формате ЧЧ:MM
        required: false, // Необязательное поле
    },
});

// Создаем модель пользователя
const User = mongoose.model('User', userSchema); // Создаем модель на основе схемы

module.exports = User; // Экспортируем модель пользователя
```

## 5. Создание Telegram бота

### Файл: `botApp.js`

```javascript
// botApp.js

// botApp.js
const express = require('express'); // Подключаем библиотеку express
const bodyParser = require('body-parser'); // Подключаем body-parser для обработки JSON
const TelegramBot = require('node-telegram-bot-api'); // Подключаем библиотеку для работы с Telegram API
const connectDB = require('./db'); // Подключаем функцию подключения к MongoDB
const User = require('./User'); // Подключаем модель пользователя

const app = express(); // Создаем экземпляр приложения express
const PORT = process.env.PORT || 3030; // Устанавливаем порт для сервера
const TELEGRAM_TOKEN = 'token'; // Заменяем на наш токен
const WEBHOOK_URL = 'https://tc-app.ru/webhook'; // Заменяем на наш URL

// Подключаемся к MongoDB
connectDB(); // Вызываем функцию подключения к базе данных

// Middleware для обработки входящих запросов
app.use(bodyParser.json()); // Используем body-parser для обработки JSON

// Объявляем bot в глобальной области видимости
let bot;

// Функция для установки вебхука
const setWebhook = async () => {
  bot = new TelegramBot(TELEGRAM_TOKEN); // Создаем экземпляр бота с токеном
  try {
    await bot.setWebHook(WEBHOOK_URL); // Устанавливаем вебхук
    console.log('Webhook установлен успешно'); // Выводим сообщение об успешной установке
  } catch (error) {
    console.error('Ошибка установки вебхука:', error.message); // Обрабатываем ошибки установки
    process.exit(1); // Завершаем процесс при ошибке
  }
};

// Обработка входящих сообщений
app.post('/webhook', async (req, res) => {
  const message = req.body.message; // Получаем сообщение из тела запроса
  if (message && message.text) { // Проверяем, есть ли текст сообщения
    const chatId = message.chat.id; // Получаем ID чата
    const userName = message.from.first_name; // Получаем имя пользователя
    const lastName = message.from.last_name || ''; // Получаем фамилию пользователя (если есть)
    const username = message.from.username || ''; // Получаем имя пользователя в Telegram (если есть)

    // Сохраняем пользователя в базе данных
    await User.findOneAndUpdate(
            { chatId: chatId.toString() }, // Ищем пользователя по chatId
            { firstName: userName, lastName: lastName, username: username }, // Обновляем или создаем запись
            { upsert: true, new: true } // Создаем новую запись, если не найдена
    );

    // Ответ на команду /sleep
    if (message.text === '/sleep') {
      bot.sendMessage(chatId, `Привет, ${userName}! Пожалуйста, укажите время, когда Вы обычно ложитесь спать (в формате ЧЧ:MM).`); // Запрашиваем время сна
    } else if (/^\d{2}:\d{2}$/.test(message.text)) { // Проверяем, соответствует ли введенное время формату ЧЧ:MM
      await User.findOneAndUpdate(
              { chatId: chatId.toString() }, // Ищем пользователя по chatId
              { sleepTime: message.text }, // Сохраняем время сна
              { new: true } // Обновляем запись
      );
      bot.sendMessage(chatId, `Спасибо! Время когда я буду напоминать Вам ложиться спать установлено на ${message.text}.`); // Подтверждаем сохранение времени
    } else {
      bot.sendMessage(chatId, `Пожалуйста, введите время в формате ЧЧ:MM.`); // Запрашиваем правильный формат
    }
  }
  res.sendStatus(200); // Отправляем статус 200 (OK)
});

// Запускаем приложение
const startApp = async () => {
  await setWebhook(); // Устанавливаем вебхук
  app.listen(PORT, () => {
    console.log(`Бот запущен на http://localhost:${PORT}`); // Выводим сообщение о запуске сервера
  });
};

startApp(); // Запускаем приложение
```

## 6. Создание приложения для уведомлений

### Файл: `notificationApp.js`

```javascript
// notificationApp.js
const TelegramBot = require('node-telegram-bot-api'); // Подключаем библиотеку для работы с Telegram API
const cron = require('node-cron'); // Подключаем библиотеку для планирования задач
const connectDB = require('./db'); // Подключаем функцию подключения к MongoDB
const User = require('./User'); // Подключаем модель пользователя

const TELEGRAM_TOKEN = '7646642994:AAHfmiv0XGA6QZttDbmPnBaect21d9-W4dA'; // Заменяем на наш токен
const WEBHOOK_URL = 'https://tc-app.ru/webhook'; // Заменяем на ваш URL

// Подключаемся к MongoDB
const startApp = async () => {
  await connectDB(); // Вызываем функцию подключения к базе данных

  // Создаем бота
  const bot = new TelegramBot(TELEGRAM_TOKEN); // Создаем экземпляр бота с токеном

  // Функция для отправки уведомлений о времени сна
  const sendSleepReminder = async () => {
    try {
      const users = await User.find(); // Получаем всех пользователей из базы данных
      const currentTime = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); // Получаем текущее время в формате ЧЧ:MM
      for (const user of users) { // Перебираем всех пользователей
        if (user.sleepTime === currentTime) { // Проверяем, совпадает ли текущее время с временем сна
          await bot.sendMessage(user.chatId, `Привет, ${user.firstName}! Вам пора ложиться спать, желаю Вам приятных сновидений!`); // Отправляем уведомление
          console.log(`Уведомление отправлено пользователю: ${user.firstName}`); // Логируем отправку уведомления
        }
      }
    } catch (error) {
      console.error('Ошибка при отправке уведомлений:', error.message); // Обрабатываем ошибки отправки
    }
  };

  // Запланировать выполнение функции каждую минуту
  cron.schedule('* * * * *', () => {
    console.log('Проверка времени сна...'); // Логируем начало проверки
    sendSleepReminder(); // Вызываем функцию отправки уведомлений
  });

  console.log('Приложение уведомлений запущено и будет проверять время сна каждую минуту.'); // Выводим сообщение о запуске приложения
};

// Запускаем приложение
startApp(); // Вызываем функцию для запуска приложения
```

## 7. Установка и настройка Nginx

### Установка Nginx

Если Nginx еще не установлен,  устанавливаем его с помощью следующей команды:

```bash
sudo apt update
sudo apt install nginx
```

### Настройка конфигурации Nginx

Создаем новый файл конфигурации для нашего сайта. Например, создайте файл `/etc/nginx/sites-available/tc-app.ru`:

```bash
sudo nano /etc/nginx/sites-available/tc-app.ru
```

Добавляем следующую конфигурацию в файл:

```nginx
server {
    listen 80;
    listen [::]:80;

    server_name tc-app.ru;
    return 301 https://$server_name$request_uri;

    server_tokens off;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name tc-app.ru;
    ssl_certificate /etc/letsencrypt/live/tc-app.ru/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/tc-app.ru/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    location /webhook {
          proxy_pass http://127.0.0.1:3030;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $remote_addr;
          proxy_set_header HTTPS $https;
          proxy_set_header  Scheme $scheme;
        }

}
```

### Включение конфигурации

Создаем символическую ссылку на файл конфигурации в директории `sites-enabled`:

```bash
sudo ln -s /etc/nginx/sites-available/tc-app.ru /etc/nginx/sites-enabled/
```

### Проверка конфигурации Nginx

Проверяем, правильно ли настроен Nginx:

```bash
sudo nginx -t
```

Если конфигурация правильная, мы увидим сообщение `syntax is ok` и `test is successful`.

### Перезапуск Nginx

Перезапускаем Nginx, чтобы применить изменения:

```bash
sudo systemctl restart nginx
```

## 8. Запуск приложений

1. Запускаем первое приложение (Telegram бот):

```bash
node botApp.js
```

2. В другом терминале запускаем второе приложение (уведомления):

```bash
node notificationApp.js
```

## Заключение

Теперь у нас есть Telegram бот, который приветствует пользователей, запрашивает время, когда они обычно ложатся спать, и отправляет им уведомления "Вам пора ложиться спать" каждый раз, когда наступает время сна. Также настроен Nginx для проксирования запросов с HTTPS на ваше приложение, запущенное на `http://localhost:3030`.

## Структура REST API

### 1. Основные компоненты

- **Модель пользователя**: Мы создали модель `User`, которая хранит информацию о пользователях, включая их `chatId`, `firstName`, `lastName`, `username`, `createdAt` и `sleepTime`.
  
- **Вебхук**: Бот использует вебхук для получения обновлений от Telegram. Все входящие сообщения обрабатываются на конечной точке `/webhook`.

### 2. Конечные точки (Endpoints)

#### 2.1. `/webhook` (POST)

- **Описание**: Эта конечная точка обрабатывает входящие сообщения от Telegram.
- **Функциональность**:
  - При получении команды `/sleep` бот запрашивает у пользователя время, когда он обычно ложится спать.
  - Если пользователь вводит время в формате ЧЧ:MM, это время сохраняется в базе данных.
  
- **Пример запроса**:
  ```json
  {
      "update_id": 123456789,
      "message": {
          "chat": {
              "id": 123456789,
              "first_name": "Николай",
              "last_name": "Школьный",
              "username": "@nick_shkolny"
          },
          "text": "/sleep"
      }
  }
  ```

- **Пример ответа**:
  ```
  Привет, Николай! Пожалуйста, укажите время, когда вы обычно ложитесь спать (в формате ЧЧ:MM).
  ```

#### 2.2. Модель пользователя (CRUD операции)

В текущей реализации есть:

- **Создание пользователя**: При первом взаимодействии с ботом пользователь автоматически создается в базе данных.
  
- **Чтение пользователя**: Когда пользователь снова ввдет комагду /sleep он будет найден в базе.

- **Обновление пользователя**: Время сна обновляется, когда пользователь вводит новое время, а так же обновляются его данные (Имя, Фамилия и никнейм).


### 3. Уведомления

- **Функция отправки уведомлений**: Каждую минуту приложение проверяет текущее время и сравнивает его с временем сна, сохраненным в базе данных. Если время совпадает, пользователю отправляется уведомление.

- **Пример уведомления**:
  ```
  Привет, Николай! Вам пора ложиться спать, желаю Вам приятных сновидений!
  ```

## Выводы

Таким образом, мы получили простое REST API, которое позволяет взаимодействовать с пользователями Telegram бота. API обрабатывает входящие сообщения, сохраняет данные пользователей в базе данных и отправляет уведомления в соответствии с заданным временем сна. 
