# Инструкция по запуску Telegram бота и веб-сервера

## Установка и настройка

### 1. Устанавливаем Node.js и npm

Убеждаемся, что у нас установлены Node.js и npm. Если нет, скачиваем и устанавливаем их с [официального сайта Node.js](https://nodejs.org/).

### 2. Создаем проект

Создаем новую директорию для нашего проекта и переходим в нее:

```bash
mkdir telegram-bot-app
cd telegram-bot-app
````


### 3. Инициализируем проект

Инициализируем новый проект Node.js:

```bash
npm init -y
```


### 4. Устанавливаем необходимые зависимости

Устанавливаем необходимые пакеты:

```bash
npm install express body-parser ejs node-telegram-bot-api ws
```


### 5. Получаем токен Telegram бота

- Регистрируем нового бота через [BotFather](https://t.me/botfather) в Telegram.
- Получаем токен нашего бота.

### 6. Создаем файл сервера

Создаем файл `server.js` и вставляем в него следующий код:

```javascript
// server.js
const express = require('express'); // Подключаем Express для создания веб-сервера
const bodyParser = require('body-parser'); // Подключаем body-parser для обработки данных из POST-запросов
const TelegramBot = require('node-telegram-bot-api'); // Подключаем библиотеку для работы с Telegram Bot API
const WebSocket = require('ws'); // Подключаем библиотеку WebSocket

const app = express(); // Создаем экземпляр приложения Express
const PORT = 3000; // Устанавливаем порт, на котором будет работать сервер
const TELEGRAM_BOT_TOKEN = 'YOUR_TELEGRAM_BOT_TOKEN'; // Токен вашего Telegram бота

// Создаем экземпляр бота с использованием метода опроса
const bot = new TelegramBot(TELEGRAM_BOT_TOKEN, { polling: true });

let pendingAdmins = []; // Массив для хранения данных пользователей, ожидающих одобрения

app.set('view engine', 'ejs'); // Устанавливаем EJS как шаблонизатор
app.use(bodyParser.urlencoded({ extended: true })); // Настраиваем body-parser для обработки URL-кодированных данных

// Создаем WebSocket сервер
const wss = new WebSocket.Server({ noServer: true });

wss.on('connection', (ws) => {
    ws.send(JSON.stringify(pendingAdmins)); // Отправляем текущие данные при подключении
});

// Обработка команды /newadmin
bot.onText(/\/newadmin/, (msg) => {
    const chatId = msg.chat.id; // Получаем ID чата
    // Отправляем сообщение пользователю с просьбой ввести данные
    bot.sendMessage(chatId, 'Пожалуйста, отправьте ваш номер телефона, фамилию, имя и отчество через запятую.');
});

// Обработка сообщений от пользователей
bot.on('message', (msg) => {
    const chatId = msg.chat.id; // Получаем ID чата
    const text = msg.text; // Получаем текст сообщения

    // Пропускаем сообщение, если это команда
    if (text.startsWith('/')) return;

    const userDetails = text.split(','); // Разделяем текст на части по запятой
    if (userDetails.length === 4) { // Проверяем, что пользователь ввел все необходимые данные
        const newAdmin = {
            chatId, // Сохраняем ID чата для последующего взаимодействия
            phone: userDetails[0].trim(), // Извлекаем и очищаем номер телефона
            surname: userDetails[1].trim(), // Извлекаем и очищаем фамилию
            name: userDetails[2].trim(), // Извлекаем и очищаем имя
            patronymic: userDetails[3].trim() // Извлекаем и очищаем отчество
        };
        pendingAdmins.push(newAdmin); // Добавляем нового пользователя в массив ожидающих одобрения
        bot.sendMessage(chatId, 'Ваши данные отправлены на одобрение.'); // Уведомляем пользователя о том, что его данные отправлены

        // Отправляем обновленные данные всем подключенным клиентам
        wss.clients.forEach(client => {
            if (client.readyState === WebSocket.OPEN) { // Проверяем, что соединение открыто
                client.send(JSON.stringify(pendingAdmins)); // Отправляем обновленный список ожидающих администраторов
            }
        });
    }
});

app.get('/', (req, res) => {
    res.render('index', { pendingAdmins }); // Рендерим страницу с использованием EJS и передаем данные
});

app.post('/approve', (req, res) => {
    const chatId = req.body.chatId; // Получаем ID чата из запроса
    pendingAdmins = pendingAdmins.filter(admin => admin.chatId !== chatId); // Удаляем пользователя из списка ожидающих одобрения
    bot.sendMessage(chatId, 'Вы были одобрены как администратор.'); // Уведомляем пользователя о том, что он одобрен

    // Отправляем обновленные данные всем подключенным клиентам
    wss.clients.forEach(client => {
        if (client.readyState === WebSocket.OPEN) { // Проверяем, что соединение открыто
            client.send(JSON.stringify(pendingAdmins)); // Отправляем обновленный список ожидающих администраторов
        }
    });

    res.redirect('/'); // Перенаправляем на главную страницу
});

// Настраиваем сервер для работы с WebSocket
const server = app.listen(PORT, () => {
    console.log(`Сервер запущен на http://localhost:${PORT}`); // Выводим сообщение о запуске сервера
});

server.on('upgrade', (request, socket, head) => {
    wss.handleUpgrade(request, socket, head, (ws) => {
        wss.emit('connection', ws, request); // Обрабатываем обновление соединения для WebSocket
    });
});
```


### 7. Создаем шаблон EJS

Создаем директорию `views` и файл `index.ejs` внутри нее:

```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"> <!-- Устанавливаем кодировку документа -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Устанавливаем масштабирование для мобильных устройств -->
    <title>Одобрение админов</title> <!-- Заголовок страницы -->
    <script>
        document.addEventListener('DOMContentLoaded', () => { // Ждем загрузки DOM
            const tableBody = document.getElementById('admin-table-body'); // Получаем элемент таблицы для вставки данных
            const ws = new WebSocket(`ws://${window.location.host}`); // Устанавливаем WebSocket соединение с сервером

            ws.onmessage = (event) => { // Обрабатываем входящие сообщения от сервера
                const pendingAdmins = JSON.parse(event.data); // Парсим данные из JSON
                tableBody.innerHTML = ''; // Очищаем таблицу перед обновлением
                pendingAdmins.forEach(admin => { // Проходим по каждому администратору в списке
                    const row = document.createElement('tr'); // Создаем новую строку таблицы
                    row.innerHTML = `
                        <td>${admin.phone}</td> <!-- Вставляем номер телефона -->
                        <td>${admin.surname}</td> <!-- Вставляем фамилию -->
                        <td>${admin.name}</td> <!-- Вставляем имя -->
                        <td>${admin.patronymic}</td> <!-- Вставляем отчество -->
                        <td>
                            <form action="/approve" method="POST"> <!-- Форма для одобрения администратора -->
                                <input type="hidden" name="chatId" value="${admin.chatId}"> <!-- Скрытое поле с ID чата -->
                                <button type="submit">Одобрить</button> <!-- Кнопка для отправки формы -->
                            </form>
                        </td>
                    `;
                    tableBody.appendChild(row); // Добавляем строку в таблицу
                });
            };
        });
    </script>
</head>
<body>
    <h1>Одобрение админов</h1> <!-- Заголовок страницы -->
    <table border="1"> <!-- Начало таблицы с рамкой -->
        <thead>
            <tr>
                <th>Телефон</th> <!-- Заголовок столбца для телефона -->
                <th>Фамилия</th> <!-- Заголовок столбца для фамилии -->
                <th>Имя</th> <!-- Заголовок столбца для имени -->
                <th>Отчество</th> <!-- Заголовок столбца для отчества -->
                <th>Действие</th> <!-- Заголовок столбца для действий -->
            </tr>
        </thead>
        <tbody id="admin-table-body"> <!-- Тело таблицы, куда будут добавляться строки -->
            <% pendingAdmins.forEach(admin => { %> <!-- Серверный код EJS для перебора списка администраторов -->
                <tr>
                    <td><%= admin.phone %></td> <!-- Вставляем номер телефона -->
                    <td><%= admin.surname %></td> <!-- Вставляем фамилию -->
                    <td><%= admin.name %></td> <!-- Вставляем имя -->
                    <td><%= admin.patronymic %></td> <!-- Вставляем отчество -->
                    <td>
                        <form action="/approve" method="POST"> <!-- Форма для одобрения администратора -->
                            <input type="hidden" name="chatId" value="<%= admin.chatId %>"> <!-- Скрытое поле с ID чата -->
                            <button type="submit">Одобрить</button> <!-- Кнопка для отправки формы -->
                        </form>
                    </td>
                </tr>
            <% }) %> <!-- Конец серверного кода EJS -->
        </tbody>
    </table>
</body>
</html>
```


### 8. Запускаем сервер

Запускаем сервер с помощью Node.js:

```bash
node server.js
```


Теперь наш сервер и бот Telegram должны быть запущены. Мы можем взаимодействовать с ботом в Telegram и управлять заявками на веб-странице, доступной по адресу `http://localhost:3000`.
