# Инструкция по созданию и настройке проекта на TypeScript с Telegram ботом

## Шаг 1: Установка Node.js и npm

1. **Скачиваем и устанавливаем Node.js**:

    ```bash
   sudo apt install -y nodejs
   ```

2. **Проверяем установку**:
   ```bash
   node -v  # Проверяем версию Node.js
   npm -v   # Проверяем версию npm
   ```

## Шаг 2: Создание нового проекта

1. **Создаем новую папку для проекта**:
   ```bash
   mkdir telegram-bot-ts  # Создаем папку с именем telegram-bot-ts
   cd telegram-bot-ts     # Переходим в созданную папку
   ```

2. **Инициализируем новый проект Node.js**:
   ```bash
   npm init -y  # Создаем файл package.json с настройками по умолчанию
   ```

## Шаг 3: Установка TypeScript и необходимых библиотек

1. **Устанавливаем TypeScript и ts-node**:
   ```bash
   npm install typescript ts-node --save-dev  # Устанавливаем TypeScript и ts-node как dev-зависимости
   ```

2. **Устанавливаем необходимые библиотеки**:
   ```bash
   npm install express node-telegram-bot-api mongoose node-cron body-parser  # Устанавливаем библиотеки для работы с Express, Telegram API, MongoDB и планировщиком задач
   ```

3. **Устанавливаем типы для TypeScript**:
   ```bash
   npm install @types/node @types/express @types/node-telegram-bot-api @types/body-parser --save-dev  # Устанавливаем типы для TypeScript
   ```

## Шаг 4: Настройка TypeScript

1. **Создаем файл конфигурации TypeScript**:
   ```bash
   npx tsc --init  # Создаем файл tsconfig.json с настройками TypeScript
   ```

  - **Настройки в tsconfig.json**:
   ```json
   {
     "compilerOptions": {
       "target": "es6",  # Указываем версию ECMAScript
       "module": "commonjs",  # Указываем модульную систему
       "strict": true,  # Включаем строгий режим
       "esModuleInterop": true,  # Включаем совместимость с ES модулями
       "skipLibCheck": true,  # Пропускаем проверку типов в библиотеках
       "forceConsistentCasingInFileNames": true,  # Обеспечиваем согласованность регистров в именах файлов
       "outDir": "./dist"  # Указываем папку для скомпилированных файлов
     },
     "include": ["src/**/*.ts"],  # Указываем папку с исходными файлами
     "exclude": ["node_modules"]  # Исключаем папку node_modules
   }
   ```

2. **Создаем структуру папок**:
   ```bash
   mkdir src  # Создаем папку src для исходных файлов
   ```

## Шаг 5: Создание файлов приложения

1. **Создаем файлы приложения**:
   В папке `src` создаем следующие файлы:
  - `db.ts`
  - `User.ts`
  - `botApp.ts`
  - `notificationApp.ts`

   ### Содержимое файлов:

   #### `db.ts`
   ```typescript
   import mongoose from 'mongoose';  // Импортируем библиотеку mongoose

   // Функция для подключения к MongoDB
   const connectDB = async () => {
     try {
       await mongoose.connect('mongodb://mongo-user-mygeobot:password@195.80.51.100:27017/mygeobot', {});
       console.log('MongoDB подключена');  // Выводим сообщение об успешном подключении
     } catch (error) {
        const err = error as Error; // Type assertion
        console.error('Ошибка подключения к MongoDB:', err.message);  // Обрабатываем ошибки подключения
        process.exit(1);  // Завершаем процесс при ошибке
     }
   };

   export default connectDB;  // Экспортируем функцию подключения
   ```

   #### `User.ts`
   ```typescript
   import mongoose, { Document, Schema } from 'mongoose';  // Импортируем mongoose и типы

   // Интерфейс для пользователя
   interface IUser extends Document {
     chatId: string;  // ID чата
     firstName: string;  // Имя пользователя
     lastName?: string;  // Фамилия пользователя (необязательное)
     username?: string;  // Имя пользователя в Telegram (необязательное)
     createdAt: Date;  // Дата создания
     sleepTime?: string;  // Время сна (необязательное)
   }

   // Определяем схему пользователя
   const userSchema: Schema = new Schema({
     chatId: { type: String, required: true, unique: true },  // Уникальный ID чата
     firstName: { type: String, required: true },  // Обязательное поле
     lastName: { type: String, required: false },  // Необязательное поле
     username: { type: String, required: false },  // Необязательное поле
     createdAt: { type: Date, default: Date.now },  // Дата создания по умолчанию
     sleepTime: { type: String, required: false },  // Время сна (необязательное)
   });

   const User = mongoose.model<IUser>('User', userSchema);  // Создаем модель пользователя
   export default User;  // Экспортируем модель пользователя
   ```

   #### `botApp.ts`
   ```typescript
   import express from 'express';  // Импортируем библиотеку express
   import bodyParser from 'body-parser';  // Импортируем body-parser для обработки JSON
   import TelegramBot from 'node-telegram-bot-api';  // Импортируем библиотеку для работы с Telegram API
   import connectDB from './db';  // Импортируем функцию подключения к MongoDB
   import User from './User';  // Импортируем модель пользователя

   const app = express();  // Создаем экземпляр приложения express
   const PORT = process.env.PORT || 3030;  // Устанавливаем порт для сервера
   const TELEGRAM_TOKEN = 'token';  // Заменяем на ваш токен
   const WEBHOOK_URL = 'https://tc-app.ru/webhook';  // Заменяем на ваш URL

   connectDB();  // Подключаемся к MongoDB
   app.use(bodyParser.json());  // Используем body-parser для обработки JSON

   let bot: TelegramBot;  // Объявляем bot в глобальной области видимости

   // Функция для установки вебхука
   const setWebhook = async () => {
     bot = new TelegramBot(TELEGRAM_TOKEN);  // Создаем экземпляр бота с токеном
     try {
       await bot.setWebHook(WEBHOOK_URL);  // Устанавливаем вебхук
       console.log('Webhook установлен успешно');  // Выводим сообщение об успешной установке
     } catch (error) {
       console.error('Ошибка установки вебхука:', error.message);  // Обрабатываем ошибки установки
       process.exit(1);  // Завершаем процесс при ошибке
     }
   };

   // Обработка входящих сообщений
   app.post('/webhook', async (req, res) => {
     const message = req.body.message;  // Получаем сообщение из тела запроса
     if (message && message.text) {  // Проверяем, есть ли текст сообщения
       const chatId = message.chat.id;  // Получаем ID чата
       const userName = message.from.first_name;  // Получаем имя пользователя
       const lastName = message.from.last_name || '';  // Получаем фамилию пользователя (если есть)
       const username = message.from.username || '';  // Получаем имя пользователя в Telegram (если есть)

       // Сохраняем пользователя в базе данных
       await User.findOneAndUpdate(
         { chatId: chatId.toString() },  // Ищем пользователя по chatId
         { firstName: userName, lastName: lastName, username: username },  // Обновляем или создаем запись
         { upsert: true, new: true }  // Создаем новую запись, если не найдена
       );

       // Ответ на команду /sleep
       if (message.text === '/sleep') {
         bot.sendMessage(chatId, `Привет, ${userName}! Пожалуйста, укажите время, когда Вы обычно ложитесь спать (в формате ЧЧ:MM).`);  // Запрашиваем время сна
       } else if (/^\d{2}:\d{2}$/.test(message.text)) {  // Проверяем, соответствует ли введенное время формату ЧЧ:MM
         await User.findOneAndUpdate(
           { chatId: chatId.toString() },  // Ищем пользователя по chatId
           { sleepTime: message.text },  // Сохраняем время сна
           { new: true }  // Обновляем запись
         );
         bot.sendMessage(chatId, `Спасибо! Время когда я буду напоминать Вам ложиться спать установлено на ${message.text}.`);  // Подтверждаем сохранение времени
       } else {
         bot.sendMessage(chatId, `Пожалуйста, введите время в формате ЧЧ:MM.`);  // Запрашиваем правильный формат
       }
     }
     res.sendStatus(200);  // Отправляем статус 200 (OK)
   });

   // Запускаем приложение
   const startApp = async () => {
     await setWebhook();  // Устанавливаем вебхук
     app.listen(PORT, () => {
       console.log(`Бот запущен на http://localhost:${PORT}`);  // Выводим сообщение о запуске сервера
     });
   };

   startApp();  // Запускаем приложение
   ```

   #### `notificationApp.ts`
   ```typescript
   import TelegramBot from 'node-telegram-bot-api';  // Импортируем библиотеку для работы с Telegram API
   import cron from 'node-cron';  // Импортируем библиотеку для планирования задач
   import connectDB from './db';  // Импортируем функцию подключения к MongoDB
   import User from './User';  // Импортируем модель пользователя

   const TELEGRAM_TOKEN = 'token';  // Заменяем на наш токен

   // Подключаемся к MongoDB
   const startApp = async () => {
     await connectDB();  // Вызываем функцию подключения к базе данных
     const bot = new TelegramBot(TELEGRAM_TOKEN);  // Создаем экземпляр бота с токеном

     // Функция для отправки уведомлений о времени сна
     const sendSleepReminder = async () => {
       try {
         const users = await User.find();  // Получаем всех пользователей из базы данных
         const currentTime = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });  // Получаем текущее время в формате ЧЧ:MM
         for (const user of users) {  // Перебираем всех пользователей
           if (user.sleepTime === currentTime) {  // Проверяем, совпадает ли текущее время с временем сна
             await bot.sendMessage(user.chatId, `Привет, ${user.firstName}! Вам пора ложиться спать, желаю Вам приятных сновидений!`);  // Отправляем уведомление
             console.log(`Уведомление отправлено пользователю: ${user.firstName}`);  // Логируем отправку уведомления
           }
         }
       } catch (error) {
          const err = error as Error; // Type assertion
          console.error('Ошибка при отправке уведомлений:', err.message);  // Обрабатываем ошибки отправки
       }
     };

     // Запланировать выполнение функции каждую минуту
     cron.schedule('* * * * *', () => {
       console.log('Проверка времени сна...');  // Логируем начало проверки
       sendSleepReminder();  // Вызываем функцию отправки уведомлений
     });

     console.log('Приложение уведомлений запущено и будет проверять время сна каждую минуту.');  // Выводим сообщение о запуске приложения
   };

   startApp();  // Вызываем функцию для запуска приложения
   ```

## Шаг 6: Компиляция и запуск приложения

1. **Компилируем TypeScript в JavaScript**:
   ```bash
   npx tsc  # Компилируем TypeScript код в JavaScript
   ```

  - Это создаст папку `dist` с скомпилированными файлами.

2. **Запускаем приложения**:
  - Для запуска `botApp.ts`:
   ```bash
   npx ts-node src/botApp.ts  # Запускаем Telegram бота
   ```

  - Для запуска `notificationApp.ts`:
   ```bash
   npx ts-node src/notificationApp.ts  # Запускаем приложение для уведомлений
   ```

  - Или, если мы хотим  запустить скомпилированные файлы:
   ```bash
   node dist/botApp.js  # Запускаем скомпилированный файл бота
   node dist/notificationApp.js  # Запускаем скомпилированный файл уведомлений
   ```

## Шаг 7: Установка и настройка Nginx 

1. **Устанавливаем Nginx**:
   ```bash
   sudo apt update  # Обновляем список пакетов
   sudo apt install nginx  # Устанавливаем Nginx
   ```

2. **Настраиваем конфигурацию Nginx**:
   Создаем новый файл конфигурации для вашего сайта:
   ```bash
   sudo nano /etc/nginx/sites-available/tc-app.ru  # Создаем файл конфигурации
   ```

   Добавляем следующую конфигурацию:
   ```nginx
   server {
       listen 80;  # Слушаем HTTP
       server_name tc-app.ru;  # Указываем доменное имя
       return 301 https://$server_name$request_uri;  # Перенаправляем на HTTPS
   }

   server {
       listen 443 ssl http2;  # Слушаем HTTPS
       server_name tc-app.ru;  # Указываем доменное имя

       ssl_certificate /etc/letsencrypt/live/tc-app.ru/fullchain.pem;  # Указываем путь к SSL сертификату
       ssl_certificate_key /etc/letsencrypt/live/tc-app.ru/privkey.pem;  # Указываем путь к ключу SSL
       include /etc/letsencrypt/options-ssl-nginx.conf;  # Включаем настройки SSL
       ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;  # Включаем параметры DH

       location /webhook {
           proxy_pass http://127.0.0.1:3030;  # Проксируем запросы на локальный сервер
           proxy_set_header Host $host;  # Устанавливаем заголовок Host
           proxy_set_header X-Real-IP $remote_addr;  # Устанавливаем заголовок X-Real-IP
           proxy_set_header X-Forwarded-For $remote_addr;  # Устанавливаем заголовок X-Forwarded-For
           proxy_set_header HTTPS $https;  # Устанавливаем заголовок HTTPS
           proxy_set_header Scheme $scheme;  # Устанавливаем заголовок Scheme
       }
   }
   ```

3. **Включаем конфигурацию**:
   ```bash
   sudo ln -s /etc/nginx/sites-available/tc-app.ru /etc/nginx/sites-enabled/  # Создаем символическую ссылку на файл конфигурации
   ```

4. **Проверяем конфигурацию Nginx**:
   ```bash
   sudo nginx -t  # Проверяем правильность конфигурации
   ```

5. **Перезапускаем Nginx**:
   ```bash
   sudo systemctl restart nginx  # Перезапускаем Nginx для применения изменений
   ```

## Заключение

Теперь у нас есть полностью настроенный проект на TypeScript с Telegram ботом и приложением для уведомлений. Мы можем запускать приложения и использовать Nginx для проксирования запросов. 
